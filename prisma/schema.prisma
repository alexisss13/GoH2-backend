// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Modelo para el registro de usuarios
model Usuario {
  id              String    @id @default(uuid())
  email           String    @unique
  nombre          String
  passwordHash    String
  fechaNacimiento DateTime?
  genero          String?
  alturaCm        Int?
  pesoKg          Float?
  nivelActividad  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  unidadMedida UnidadMedida @default(ML)

  // Relaciones
  registros RegistroBebida[]
  objetivos ObjetivoHidratacion[]
  pedidos Pedido[]
  // Usuarios que yo estoy siguiendo (soy el 'seguidor')
  siguiendo  Follow[] @relation("Seguidor")
  // Usuarios que me siguen a mí (soy el 'seguido')
  seguidores Follow[] @relation("Seguido")

  likes       Like[]
  comentarios Comentario[]

  passwordResetTokens PasswordResetToken[]
}

// Modelo para los tipos de bebidas disponibles
model Bebida {
  id     String @id @default(uuid())
  nombre String @unique // "Agua", "Café", "Té", etc.

  // El factor para calcular el aporte hídrico real.
  // Basado en "100 ml de aporte hídrico" para "100 ml" de "Agua" 
  // Agua = 1.0, otras bebidas pueden tener factores diferentes.
  factorHidratacion Float @default(1.0)

  // Relación
  registros RegistroBebida[]
}

// Modelo para los registros de consumo de bebidas 
model RegistroBebida {
  id                  String       @id @default(uuid())
  cantidadConsumidaMl Int // Ej: 100ml 
  aporteHidricoMl     Int // Ej: 100ml  (Calculado: cantidadConsumidaMl * bebida.factorHidratacion)
  fechaHora           DateTime     @default(now()) // 
  tipoRegistro        TipoRegistro // "Manual" o "Digital" 

  // Relación con Usuario
  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  // Relación con Bebida
  bebidaId String
  bebida   Bebida @relation(fields: [bebidaId], references: [id])

  likes       Like[]
  comentarios Comentario[]

  @@index([usuarioId, fechaHora])
}

// Modelo para el objetivo de hidratación diario 
model ObjetivoHidratacion {
  id         String   @id @default(uuid())
  fecha      DateTime @db.Date // El día específico del objetivo
  cantidadMl Int // Ej: 1264 ml 

  // Relación con Usuario
  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, fecha])
}

// Modelo para el sistema de "Seguir" (Twitter/Instagram style)
model Follow {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Quién sigue
  seguidorId String
  seguidor   Usuario @relation("Seguidor", fields: [seguidorId], references: [id], onDelete: Cascade)

  // A quién sigue
  seguidoId String
  seguido   Usuario @relation("Seguido", fields: [seguidoId], references: [id], onDelete: Cascade)

  // Índice único para asegurar que no se pueda seguir dos veces
  @@unique([seguidorId, seguidoId])
  @@index([seguidorId])
  @@index([seguidoId])
}

enum TipoRegistro {
  MANUAL
  DIGITAL
}

enum UnidadMedida {
  ML
  OZ
}

model Like {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Relación con el usuario que da el like
  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  // Relación con el registro al que se da like
  registroId String
  registro   RegistroBebida @relation(fields: [registroId], references: [id], onDelete: Cascade)

  // Índice único para que un usuario solo pueda dar like una vez
  @@unique([usuarioId, registroId])
}

model Comentario {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  texto     String   @db.Text // El contenido del comentario

  // Relación con el usuario que comenta
  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  // Relación con el registro que se comenta
  registroId String
  registro   RegistroBebida @relation(fields: [registroId], references: [id], onDelete: Cascade)

  @@index([registroId, createdAt])
}

// Almacena tokens para restablecer contraseña
model PasswordResetToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique // Almacenamos el hash del token
  expiresAt DateTime // Cuándo expira el token

  // Relación con el usuario
  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
}

//ecommerce


model Pedido {
  id              String         @id @default(uuid())
  usuarioId       String
  usuario         Usuario        @relation(fields: [usuarioId], references: [id])
  
  subtotal        Float
  costoEnvio      Float
  total           Float
  moneda          String         @default("PEN")
  
  estado          String         @default("PENDIENTE") // PENDIENTE, PAGADO, ENVIADO
  
  // Datos de Envío
  nombreReceptor  String
  telefonoContact String
  direccion       String
  ciudad          String
  codigoPostal    String?
  notas           String?

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  detalles        DetallePedido[]
  pagos           Pago[]

  @@index([usuarioId])
}

model DetallePedido {
  id               String  @id @default(uuid())
  pedidoId         String
  pedido           Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  
  productoIdStrapi String  
  nombre           String
  precioUnitario   Float
  cantidad         Int
  imagenUrl        String?
  varianteColor    String? 
  
  subtotalLinea    Float
}

model Pago {
  id              String   @id @default(uuid())
  pedidoId        String
  pedido          Pedido   @relation(fields: [pedidoId], references: [id])
  
  monto           Float
  metodoPago      String   // "IZIPAY", "YAPE"
  referenciaExt   String?  
  estado          String   @default("PENDIENTE") 
  
  fechaPago       DateTime?
  createdAt       DateTime @default(now())
}